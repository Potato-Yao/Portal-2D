<!DOCTYPE html>

<html>

<head>
    <title>Exitless Day</title>
    <meta charset="utf-8">
    <link rel="Shortcut Icon" href="./assets/ico/exit.png" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scale=no">
    <link rel="stylesheet" type="text/css" href="./assets/style/base.css">
    <link rel="stylesheet" type="text/css" href="./assets/style/start.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Serif+SC:wght@200..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Noto+Sans+SC:wght@100..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="menu">
        <div class="title">
            <!-- <div class="vertical">
                <div>标</div>
                <div>题</div>
            </div> -->
            <div class="horizontal">
                <!-- <div class="text">
                    Exitless <br> Day
                </div> -->
                <div class="icon">
                    <img src="./assets/icon.svg" />
                </div>
            </div>
        </div>
        <div class="button-container" style="opacity: 0; transition: opacity 0.5s ease-in-out;">
            <div class="button" id="start">开始新游戏</div>
            <div class="button" id="load">加载存档</div>
            <div class="button" id="achievement">成就！</div>
            <div class="button" id="exit">退出</div>
        </div>
        <!-- <div class="side">
            这里不知道要写啥 <br>
            但是看起来很吊所以没删 <br>
            如果不写东西最好还是删了
        </div> -->
    </div>

    <div class="save hide" id="save-load">
        <div class="save-container"></div>
        <div class="button-container">
            <div class="button" id="save-back">返回</div>
        </div>
    </div>

    <div class="achievementDisp hide">
        <div class="achievement-container">
            <div class="title">成就</div>
            <div class="list"></div>
        </div>
        <div class="achievement-button" id="achievement-back">返回</div>
    </div>

    <div class="cursor-follower"></div>
    <div class="cursor-inner"></div>

    <div class="transition hidden">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>

    <div id="resource" style="display: none;"></div>

    <script type="text/javascript" src="script/utils/Store.js"></script>
    <script type="text/javascript" src="script/utils/Auth.js"></script>
    <script type="text/javascript" src="script/utils/Save.js"></script>
    <script type="text/javascript" src="script/utils/Vector.js"></script>
    <script type="text/javascript" src="script/utils/Hitbox.js"></script>
    <script type="text/javascript" src="script/utils/AchievementDisp.js"></script>
    <script type="text/javascript" src="script/Managers/AchievementManager.js"></script>
    <script type="text/javascript" src="script/Managers/DataManager.js"></script>

    <script type="text/javascript">
        window.$gameState = 0;

        // 鼠标跟随
        const cursorFollower = document.querySelector(".cursor-follower");
        const cursorInnerFollower = document.querySelector(".cursor-inner");
        document.addEventListener('mousemove', (event) => {
            cursorFollower.style.left = event.clientX + 'px';
            cursorFollower.style.top = event.clientY + 'px';
            cursorInnerFollower.style.left = event.clientX + 'px';
            cursorInnerFollower.style.top = event.clientY + 'px';
        });

        // 添加鼠标点击动画效果
        const cursorOuter = document.querySelector('.cursor-follower');
        const cursorInner = document.querySelector('.cursor-inner');
        document.addEventListener('mousedown', () => {
            cursorOuter.classList.add('active');
            cursorInner.classList.add('active');
        });
        document.addEventListener('mouseup', () => {
            cursorOuter.classList.remove('active');
            cursorInner.classList.remove('active');
        });

        const FADE_IN_GAP_TIME = 600, FADE_OUT_GAP_TIME = 1800, GAPTIME = 1800;

        const fadeIn = () => {
            const transition = document.querySelector(".transition");
            transition.classList.remove("hidden");
            transition.classList.add("fadeIn");
            setTimeout(() => {
                transition.classList.add("hidden");
                transition.classList.remove("fadeIn");
                /*
                    修改之处 (第二处):
                    在页面淡入动画结束后，将按钮容器的透明度设为1，使其显示出来。
                */
                document.querySelector(".menu .button-container").style.opacity = 1;
                cursorInner.style.opacity = 0.8;
            }, FADE_IN_GAP_TIME);
        };

        const fadeOut = () => {
            const transition = document.querySelector(".transition");
            transition.classList.remove("hidden");
            transition.classList.add("fadeOut");
            setTimeout(() => {
                transition.classList.add("hidden");
                transition.classList.remove("fadeOut");
            }, FADE_OUT_GAP_TIME);
        };

        window.onload = async () => {
            window.$store = new Store();
            Store.remove("toLoad");

            window.$game = {
                dataManager: new DataManager(),
            }

            const achievementDisp = new AchievementDisp(
                document.querySelector(".achievement-container > .list")
            );

            const load = new Load((data) => {
                Store.set("toLoad", JSON.stringify(data));
                window.location.href = `./game.html?${window.$store.encode()}`;
            })

            fadeIn();

            // 初始化CSS变量闪烁效果
            let enableFlickAnimation = false;
            // 初始禁用闪烁效果
            let isOriginal = true;
            const sleep = (ms) => {
                return new Promise(resolve => setTimeout(resolve, ms));
            };
            const switchColor = () => {
                const root = document.documentElement;
                if (isOriginal) {
                    root.style.setProperty('--theme', '#000000');
                    root.style.setProperty('--button-color', '#193bb6');
                } else {
                    root.style.setProperty('--theme', '#193bb6');
                    root.style.setProperty('--button-color', '#bababa');
                }
                isOriginal = !isOriginal;
            };
            const flick = async () => {
                switchColor();
                await sleep(100);
                switchColor();
                await sleep(50);
                switchColor();
                await sleep(10000);
                switchColor();
                await sleep(150);
                switchColor();
                await sleep(100);
                switchColor();
            };

            if(enableFlickAnimation) {
                await (async () => {
                    await sleep(10000);
                    await flick();
                    await sleep(10000);
                })();
                setInterval(flick, 20000);
            }

            if (!Auth.isAuthenticated()) {
                Auth.toLogin();
            }

            let canScroll = false;

            const achievementManager = new AchievementManager();

            document.querySelector("#start").addEventListener("click", () => {
                fadeOut();
                setTimeout(() => {
                    console.log(window.$store)
                    window.location.href = `./game.html?${window.$store.encode()}`;
                }, GAPTIME);
            });
            document.querySelector("#load").addEventListener("click", () => {
                fadeOut();
                setTimeout(() => {
                    document.querySelector(".menu").classList.add("hide");
                    document.querySelector(".save").classList.remove("hide");
                    load.build();
                    fadeIn();
                }, GAPTIME);
            });
            document.querySelector("#save-back").addEventListener("click", () => {
                fadeOut();
                setTimeout(() => {
                    document.querySelector(".save").classList.add("hide");
                    document.querySelector(".save-container").innerHTML = "";
                    document.querySelector(".menu").classList.remove("hide");
                    fadeIn();
                }, GAPTIME);
            });
            document.querySelector("#achievement").addEventListener("click", () => {
                fadeOut();
                if (!Store.get("achievements") || !AchievementManager.getAll().length) {
                    achievementManager.refresh();
                }
                setTimeout(() => {
                    document.querySelector(".menu").classList.add("hide");
                    document.querySelector(".achievementDisp").classList.remove("hide");
                    achievementDisp.disp();
                    fadeIn();
                    canScroll = true;
                }, GAPTIME);
            });
            document.querySelector("#achievement-back").addEventListener("click", () => {
                fadeOut();
                canScroll = false;
                setTimeout(() => {
                    document.querySelector(".achievementDisp").classList.add("hide");
                    document.querySelector(".achievement-container > .list").innerHTML = "";
                    document.querySelector(".menu").classList.remove("hide");
                    fadeIn();
                }, GAPTIME);
            });
            document.querySelector("#exit").addEventListener("click", () => {
                Auth.logout();
                Auth.toLogin();
            });

            document.querySelector(".achievementDisp").addEventListener("scroll", (e) => {
                if (canScroll) {
                    // let offsetY = e.target.scrollLeft * Math.tan(10 / 180 * Math.PI)
					let offsetY = 0; // 去除斜向滚动
                    document.querySelector(".achievementDisp").style.setProperty("--offsetY", `${offsetY}px`);
                }
            })
            await achievementManager.load()
        }
    </script>
</body>

</html>
